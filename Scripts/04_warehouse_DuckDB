import duckdb
import os

# 1. Configuration des chemins
CURATED_PATH = './Data_lake/curated/'
WAREHOUSE_PATH = './warehouse/'
DB_NAME = 'dvf_market.db'

# Création du dossier warehouse s'il n'existe pas
os.makedirs(WAREHOUSE_PATH, exist_ok=True)

# 2. Création/Connexion à la base de données DuckDB
# Si le fichier n'existe pas, DuckDB le crée automatiquement
db_path = os.path.join(WAREHOUSE_PATH, DB_NAME)
con = duckdb.connect(db_path)

print(f"Connexion établie à : {db_path}")

# 3. Chargement des datasets Curated en tables SQL
# DuckDB a une fonction magique pour lire les CSV directement
try:
    # Création de la table pour les indicateurs mensuels
    con.execute(f"""
        CREATE OR REPLACE TABLE fact_monthly_indicators AS 
        SELECT * FROM read_csv_auto('{os.path.join(CURATED_PATH, 'france_mensuel.csv')}')
    """)
    
    # Création de la table pour le top volume
    con.execute(f"""
        CREATE OR REPLACE TABLE dim_top_departments_volume AS 
        SELECT * FROM read_csv_auto('{os.path.join(CURATED_PATH, 'top_dep_volume.csv')}')
    """)
    # Création de la table pour le top prix
    con.execute(f"""
        CREATE OR REPLACE TABLE dim_top_departments_price AS 
        SELECT * FROM read_csv_auto('{os.path.join(CURATED_PATH, 'top_dep_prix.csv')}')
    """)
    
    print("✅ Tables créées avec succès dans le Warehouse.")

except Exception as e:
    print(f"❌ Erreur lors de la création des tables : {e}")

# 4. Vérification rapide
print("\nListe des tables dans la base :")
print(con.execute("SHOW TABLES").fetchall())

# Toujours fermer la connexion
con.close()